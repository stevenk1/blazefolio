@using BlazeFolio.Application.Wallets.Features.Commands
@using BlazeFolio.Services
@using MediatR
@using BlazeFolio.Domain.WalletAggregate
@inject IMediator Mediator
@inject ErrorHandler ErrorHandler
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudContainer Style="max-width: 500px;">
            
            <MudForm @ref="form" Model="@walletModel" @bind-IsValid="@isValid">
                <MudTextField T="string" 
                              @bind-Value="walletModel.Name" 
                              Label="Wallet Name" 
                              Required="true" 
                              RequiredError="Name is required"
                              Class="mb-3"/>
                              
                <MudSelect T="WalletType" 
                          @bind-Value="walletModel.Type" 
                          Label="Wallet Type" 
                          Required="true"
                          RequiredError="Wallet type is required"
                          Class="mb-3">
                    <MudSelectItem Value="WalletType.Crypto" Disabled="true">Crypto (Coming Soon)</MudSelectItem>
                    <MudSelectItem Value="WalletType.StockExchange">Stock Exchange</MudSelectItem>
                </MudSelect>
            </MudForm>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" Disabled="@(!isValid)" Variant="Variant.Filled">Add Wallet</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    
    private MudForm form = null!;
    private bool isValid;
    private bool processing;
    
    private WalletModel walletModel = new();
    
    private class WalletModel
    {
        public string Name { get; set; } = string.Empty;
        public string Symbol { get; set; } = "BTC";
        public WalletType Type { get; set; } = WalletType.StockExchange;
    }
    
    private void Cancel()
    {
        MudDialog.Cancel();
    }
    
    private async Task Submit()
    {
        if (!isValid || processing) 
            return;
        
        processing = true;
        
        try
        {
            var command = new AddWalletCommand
            {
                Name = walletModel.Name,
                Type = walletModel.Type
                // Note: Adjust the actual command properties based on what AddWalletCommand accepts
                // The command might need adjustments if it has different properties
            };
            
            var result = await Mediator.Send(command);
            
            if (result.IsSuccess)
            {
                Snackbar.Add("Wallet added successfully", MudBlazor.Severity.Success);
                MudDialog.Close(DialogResult.Ok(result.Value));
            }
            else
            {
                Snackbar.Add(result.Error, MudBlazor.Severity.Error);
            }
        }
        catch (Exception ex)
        {
            ErrorHandler.HandleException(ex, "Error adding wallet", "AddWallet.Submit");
            Snackbar.Add("Failed to add wallet", MudBlazor.Severity.Error);
        }
        finally
        {
            processing = false;
        }
    }
}
